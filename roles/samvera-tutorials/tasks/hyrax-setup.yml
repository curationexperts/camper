---
# ROLE: samvera-tutorials
# roles/samvera-tutorials/tasks/hyrax-setup.yml
#
# Pre-load gem dependencies required by Hyrax-based tutorials
#

- name: disable gem documentation
  lineinfile: "dest=~/.gemrc line='gem: --no-document' create=yes state=present"

- name: install rails version to use for Hydra tutorials
  command: ".rvm/bin/rvm all do gem install rails -v {{ rails_version }}"

- name: generate demo app
  command: ".rvm/bin/rvm all do rails new hyrax-sample --skip-spring"

- name: add Hyrax dependency to gemfile
  lineinfile:
    path: /home/{{ ansible_ssh_user }}/hyrax-sample/Gemfile 
    state: present
    line: "gem 'hyrax', '2.1.0.beta2'"

# Pin Redis gem version - see https://github.com/samvera/hyrax/tree/master#enable-notifications
- name: pin redis gem to 3.x
  lineinfile:
    path: /home/{{ ansible_ssh_user }}/hyrax-sample/Gemfile 
    state: present
    line: "gem 'redis', '~> 3.0'"
# Remove this task and the one above once the Redis compatibility issue is resolved
  
- name: bundle install Hyrax dependencies
  command: "~/.rvm/bin/rvm all do bundle install --gemfile ~/hyrax-sample/Gemfile" 
  
- name: pre-run the Hyrax generator
  command: bash -lc "cd ~/hyrax-sample/ && rails generate hyrax:install -f"  

- name: pre-run the db migrations for Hyrax
  command: bash -lc "cd ~/hyrax-sample/ && rails db:migrate"   

- name: set up the default collections tuypes
  command: bash -lc "cd ~/hyrax-sample/ && rails hyrax:default_collection_types:create"   

- name: set solr_wrapper download directory
  lineinfile:
    path: /home/{{ ansible_ssh_user }}/hyrax-sample/.solr_wrapper
    regexp:  "download_dir:"
    state: present
    line: "download_dir: /var/tmp"

- name: set solr_wrapper to use {{ solr_version }}
  lineinfile:
    path: /home/{{ ansible_ssh_user }}/hyrax-sample/.solr_wrapper
    regexp:  "version:"
    state: present
    line: "version: {{ solr_version }}"

- name: set fcrepo_wrapper download directory
  lineinfile:
    path: /home/{{ ansible_ssh_user }}/hyrax-sample/.fcrepo_wrapper
    regexp:  "download_dir:"
    state: present
    line: "download_dir: /var/tmp"

- name: set fcrepo_wrapper to use {{ fcrepo_version }}
  lineinfile:
    path: /home/{{ ansible_ssh_user }}/hyrax-sample/.fcrepo_wrapper
    regexp: "version:"
    state: present
    line: "version: {{ fcrepo_version }}"

- name: run redis
  service: name=redis-server state=started

- name: start the hyrax development server
  command: bash -lc "cd ~/hyrax-sample/ && rails hydra:server "
  async: 3600 
  poll: 0
  
- name: wait for development server to spin up
  wait_for:
    port: 3000
    delay: 10

- name: configure default admin set for Hyrax
  command: bash -lc "cd ~/hyrax-sample/ && rails hyrax:default_admin_set:create"

- name: configure default workflows for Hyrax
  command: bash -lc "cd ~/hyrax-sample/ && rails hyrax:workflow:load"

- name: pre-run the work generator for a Work
  command: bash -lc "cd ~/hyrax-sample/ && rails generate hyrax:work Work"
